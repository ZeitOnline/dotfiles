{{ range $db := (secretJSON "kv" "list" "-format=json" "cloudsql/databases") }}
{{ $key := (print "cloudsql/databases/" $db) }}
{{ $instance := (print "cloudsql/instances/" (vault $key).data.instance) }}
[{{ (vault $key).data.name }}-{{ (vault $instance).data.environment }}]
hostaddr={{ (vault $key).data.host }}
port=5432
user={{ (vault $key).data.user }}
password={{ (vault $key).data.password }}
dbname={{ (vault $key).data.name }}
sslmode=verify-ca
sslcert={{ (env "HOME") }}/.pg_services/{{ (vault $key).data.instance }}-client.crt
sslkey={{ (env "HOME") }}/.pg_services/{{ (vault $key).data.instance }}-client.key
sslrootcert={{ (env "HOME") }}/.pg_services/{{ (vault $key).data.instance }}-server-ca.pem
{{ end }}
